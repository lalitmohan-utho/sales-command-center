<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Targets Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="static-sales-dashboard.html">
                <i class="bi bi-grid-3x3-gap-fill me-2"></i>CRM Dashboard
            </a>
            <div class="d-flex align-items-center">
                <a href="static-sales-dashboard.html" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1">Sales Targets</h2>
                <p class="text-muted mb-0">Track and manage sales targets and achievements</p>
            </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTargetModal">
                <i class="bi bi-plus-lg me-2"></i>Add Target
            </button>
        </div>

        <!-- Chart -->
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h6 class="mb-0">Target vs Achievement</h6>
            </div>
            <div class="card-body">
                <canvas id="targetChart" height="100"></canvas>
            </div>
        </div>

        <!-- Targets Table -->
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="mb-0">All Targets</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Rep</th>
                                <th>Quarter</th>
                                <th>Month</th>
                                <th>Target Business</th>
                                <th>Achieved Revenue</th>
                                <th>Target MRR</th>
                                <th>Achieved MRR</th>
                                <th>Achievement</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="targetsTableBody">
                            <tr>
                                <td colspan="10" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Target Modal -->
    <div class="modal fade" id="addTargetModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Sales Target</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addTargetForm">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Rep *</label>
                                <select class="form-select" name="rep" required>
                                    <option value="TRM">TRM</option>
                                    <option value="ZRM">ZRM</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Quarter *</label>
                                <select class="form-select" name="quarter" required>
                                    <option value="Q1">Q1</option>
                                    <option value="Q2">Q2</option>
                                    <option value="Q3">Q3</option>
                                    <option value="Q4">Q4</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Month *</label>
                                <select class="form-select" name="month" required>
                                    <option value="January">January</option>
                                    <option value="February">February</option>
                                    <option value="March">March</option>
                                    <option value="April">April</option>
                                    <option value="May">May</option>
                                    <option value="June">June</option>
                                    <option value="July">July</option>
                                    <option value="August">August</option>
                                    <option value="September">September</option>
                                    <option value="October">October</option>
                                    <option value="November">November</option>
                                    <option value="December">December</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Target Business (₹)</label>
                                <input type="number" class="form-control" name="target_business" value="0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Achieved Revenue (₹)</label>
                                <input type="number" class="form-control" name="achieved_revenue" value="0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Target MRR (₹)</label>
                                <input type="number" class="form-control" name="target_mrr" value="0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Achieved MRR (₹)</label>
                                <input type="number" class="form-control" name="achieved_mrr" value="0">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Status</label>
                                <select class="form-select" name="status">
                                    <option value="On Track">On Track</option>
                                    <option value="At Risk">At Risk</option>
                                    <option value="Behind">Behind</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Target</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = 'https://jyxpsdqgrnkgknpskgdv.supabase.co/functions/v1/sales-api';
        let allTargets = [];
        let targetChart = null;

        async function fetchTargets() {
            try {
                const response = await fetch(`${API_BASE_URL}?action=targets`);
                const data = await response.json();
                allTargets = data.targets || [];
                renderTargets(allTargets);
                renderChart(allTargets);
            } catch (error) {
                console.error('Error fetching targets:', error);
            }
        }

        function renderChart(targets) {
            const ctx = document.getElementById('targetChart').getContext('2d');
            
            if (targetChart) targetChart.destroy();

            targetChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: targets.map(t => `${t.rep} - ${t.month}`),
                    datasets: [
                        {
                            label: 'Target (₹L)',
                            data: targets.map(t => t.target_business / 100000),
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Achieved (₹L)',
                            data: targets.map(t => t.achieved_revenue / 100000),
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderTargets(targets) {
            const tbody = document.getElementById('targetsTableBody');
            
            if (!targets || targets.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center py-5">No targets found</td></tr>`;
                return;
            }

            tbody.innerHTML = targets.map(t => {
                const achievement = Math.round((t.achieved_revenue / t.target_business) * 100);
                return `
                    <tr>
                        <td class="fw-medium">${t.rep}</td>
                        <td>${t.quarter}</td>
                        <td>${t.month}</td>
                        <td>₹${(t.target_business / 100000).toFixed(2)}L</td>
                        <td>₹${(t.achieved_revenue / 100000).toFixed(2)}L</td>
                        <td>₹${(t.target_mrr / 1000).toFixed(2)}K</td>
                        <td>₹${(t.achieved_mrr / 1000).toFixed(2)}K</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar ${achievement >= 100 ? 'bg-success' : achievement >= 80 ? 'bg-warning' : 'bg-danger'}" 
                                     style="width: ${Math.min(achievement, 100)}%">
                                    ${achievement}%
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge ${t.status === 'On Track' ? 'bg-success' : t.status === 'At Risk' ? 'bg-warning text-dark' : 'bg-danger'}">
                                ${t.status}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTarget('${t.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Add target
        document.getElementById('addTargetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.target_business = parseFloat(data.target_business) || 0;
            data.achieved_revenue = parseFloat(data.achieved_revenue) || 0;
            data.target_mrr = parseFloat(data.target_mrr) || 0;
            data.achieved_mrr = parseFloat(data.achieved_mrr) || 0;

            try {
                const response = await fetch(`${API_BASE_URL}?action=target`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('addTargetModal')).hide();
                    e.target.reset();
                    fetchTargets();
                    alert('Target added successfully!');
                }
            } catch (error) {
                console.error('Error adding target:', error);
            }
        });

        // Delete target
        async function deleteTarget(id) {
            if (!confirm('Are you sure you want to delete this target?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}?action=target&id=${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    fetchTargets();
                    alert('Target deleted!');
                }
            } catch (error) {
                console.error('Error deleting target:', error);
            }
        }

        fetchTargets();
    </script>
</body>
</html>