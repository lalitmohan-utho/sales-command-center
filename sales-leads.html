<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Leads Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="static-sales-dashboard.html">
                <i class="bi bi-grid-3x3-gap-fill me-2"></i>CRM Dashboard
            </a>
            <div class="d-flex align-items-center">
                <a href="static-sales-dashboard.html" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1">Sales Leads</h2>
                <p class="text-muted mb-0">Manage and track all your sales leads</p>
            </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLeadModal">
                <i class="bi bi-plus-lg me-2"></i>Add New Lead
            </button>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search leads...">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="stageFilter">
                            <option value="">All Stages</option>
                            <option value="New">New</option>
                            <option value="Contacted">Contacted</option>
                            <option value="Qualified">Qualified</option>
                            <option value="Proposal">Proposal</option>
                            <option value="Negotiation">Negotiation</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="sourceFilter">
                            <option value="">All Sources</option>
                            <option value="Website">Website</option>
                            <option value="Referral">Referral</option>
                            <option value="Cold Call">Cold Call</option>
                            <option value="LinkedIn">LinkedIn</option>
                            <option value="Email Campaign">Email Campaign</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="assignedFilter">
                            <option value="">All Reps</option>
                            <option value="TRM">TRM</option>
                            <option value="ZRM">ZRM</option>
                        </select>
                    </div>
                    <div class="col-md-3 text-end">
                        <button class="btn btn-outline-secondary" onclick="exportLeads()">
                            <i class="bi bi-download me-1"></i>Export
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leads Table -->
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Company</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Source</th>
                                <th>Stage</th>
                                <th>Status</th>
                                <th>Value</th>
                                <th>Assigned To</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leadsTableBody">
                            <tr>
                                <td colspan="10" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Lead Modal -->
    <div class="modal fade" id="addLeadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Lead</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addLeadForm">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Name *</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Company *</label>
                                <input type="text" class="form-control" name="company" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Phone</label>
                                <input type="text" class="form-control" name="phone">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Source</label>
                                <select class="form-select" name="source">
                                    <option value="Website">Website</option>
                                    <option value="Referral">Referral</option>
                                    <option value="Cold Call">Cold Call</option>
                                    <option value="LinkedIn">LinkedIn</option>
                                    <option value="Email Campaign">Email Campaign</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Stage</label>
                                <select class="form-select" name="stage">
                                    <option value="New">New</option>
                                    <option value="Contacted">Contacted</option>
                                    <option value="Qualified">Qualified</option>
                                    <option value="Proposal">Proposal</option>
                                    <option value="Negotiation">Negotiation</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Assigned To</label>
                                <select class="form-select" name="assigned_to">
                                    <option value="TRM">TRM</option>
                                    <option value="ZRM">ZRM</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Value (₹)</label>
                                <input type="number" class="form-control" name="value" value="0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Status</label>
                                <select class="form-select" name="status">
                                    <option value="Not Called">Not Called</option>
                                    <option value="Called – No Answer">Called – No Answer</option>
                                    <option value="Meeting Scheduled">Meeting Scheduled</option>
                                    <option value="Follow-up Required">Follow-up Required</option>
                                    <option value="Sent Information – Awaiting Response">Sent Information</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" name="notes" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Lead</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Lead Modal -->
    <div class="modal fade" id="editLeadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Lead</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editLeadForm">
                    <input type="hidden" name="id" id="editLeadId">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Name *</label>
                                <input type="text" class="form-control" name="name" id="editName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Company *</label>
                                <input type="text" class="form-control" name="company" id="editCompany" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email" id="editEmail">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Phone</label>
                                <input type="text" class="form-control" name="phone" id="editPhone">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Source</label>
                                <select class="form-select" name="source" id="editSource">
                                    <option value="Website">Website</option>
                                    <option value="Referral">Referral</option>
                                    <option value="Cold Call">Cold Call</option>
                                    <option value="LinkedIn">LinkedIn</option>
                                    <option value="Email Campaign">Email Campaign</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Stage</label>
                                <select class="form-select" name="stage" id="editStage">
                                    <option value="New">New</option>
                                    <option value="Contacted">Contacted</option>
                                    <option value="Qualified">Qualified</option>
                                    <option value="Proposal">Proposal</option>
                                    <option value="Negotiation">Negotiation</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Assigned To</label>
                                <select class="form-select" name="assigned_to" id="editAssigned">
                                    <option value="TRM">TRM</option>
                                    <option value="ZRM">ZRM</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Value (₹)</label>
                                <input type="number" class="form-control" name="value" id="editValue">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Status</label>
                                <select class="form-select" name="status" id="editStatus">
                                    <option value="Not Called">Not Called</option>
                                    <option value="Called – No Answer">Called – No Answer</option>
                                    <option value="Meeting Scheduled">Meeting Scheduled</option>
                                    <option value="Follow-up Required">Follow-up Required</option>
                                    <option value="Sent Information – Awaiting Response">Sent Information</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" name="notes" id="editNotes" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Lead</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API Configuration
        const API_BASE_URL = 'https://jyxpsdqgrnkgknpskgdv.supabase.co/functions/v1/sales-api';
        
        let allLeads = [];

        // Fetch leads
        async function fetchLeads() {
            try {
                const response = await fetch(`${API_BASE_URL}?action=leads`);
                const data = await response.json();
                allLeads = data.leads || [];
                renderLeads(allLeads);
            } catch (error) {
                console.error('Error fetching leads:', error);
                document.getElementById('leadsTableBody').innerHTML = `
                    <tr><td colspan="10" class="text-center py-5 text-danger">Error loading leads</td></tr>
                `;
            }
        }

        // Render leads table
        function renderLeads(leads) {
            const tbody = document.getElementById('leadsTableBody');
            
            if (!leads || leads.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center py-5">No leads found</td></tr>`;
                return;
            }

            tbody.innerHTML = leads.map(lead => `
                <tr>
                    <td class="fw-medium">${lead.name}</td>
                    <td>${lead.company}</td>
                    <td>${lead.email || '-'}</td>
                    <td>${lead.phone || '-'}</td>
                    <td><span class="badge bg-secondary">${lead.source}</span></td>
                    <td><span class="badge ${getStageClass(lead.stage)}">${lead.stage}</span></td>
                    <td><span class="badge ${getStatusClass(lead.status)}">${lead.status}</span></td>
                    <td>₹${(lead.value / 100000).toFixed(2)}L</td>
                    <td>${lead.assigned_to || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editLead('${lead.id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteLead('${lead.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getStageClass(stage) {
            const classes = {
                'New': 'bg-info',
                'Contacted': 'bg-primary',
                'Qualified': 'bg-success',
                'Proposal': 'bg-warning text-dark',
                'Negotiation': 'bg-danger'
            };
            return classes[stage] || 'bg-secondary';
        }

        function getStatusClass(status) {
            if (status.includes('Meeting') || status.includes('Done')) return 'bg-success';
            if (status.includes('No Answer') || status.includes('Not Called')) return 'bg-danger';
            if (status.includes('Follow-up')) return 'bg-warning text-dark';
            return 'bg-info';
        }

        // Add lead
        document.getElementById('addLeadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.value = parseFloat(data.value) || 0;

            try {
                const response = await fetch(`${API_BASE_URL}?action=lead`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('addLeadModal')).hide();
                    e.target.reset();
                    fetchLeads();
                    alert('Lead added successfully!');
                }
            } catch (error) {
                console.error('Error adding lead:', error);
                alert('Error adding lead');
            }
        });

        // Edit lead
        function editLead(id) {
            const lead = allLeads.find(l => l.id === id);
            if (!lead) return;

            document.getElementById('editLeadId').value = lead.id;
            document.getElementById('editName').value = lead.name;
            document.getElementById('editCompany').value = lead.company;
            document.getElementById('editEmail').value = lead.email || '';
            document.getElementById('editPhone').value = lead.phone || '';
            document.getElementById('editSource').value = lead.source;
            document.getElementById('editStage').value = lead.stage;
            document.getElementById('editAssigned').value = lead.assigned_to || 'TRM';
            document.getElementById('editValue').value = lead.value;
            document.getElementById('editStatus').value = lead.status;
            document.getElementById('editNotes').value = lead.notes || '';

            new bootstrap.Modal(document.getElementById('editLeadModal')).show();
        }

        document.getElementById('editLeadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            const id = data.id;
            delete data.id;
            data.value = parseFloat(data.value) || 0;

            try {
                const response = await fetch(`${API_BASE_URL}?action=lead&id=${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('editLeadModal')).hide();
                    fetchLeads();
                    alert('Lead updated successfully!');
                }
            } catch (error) {
                console.error('Error updating lead:', error);
                alert('Error updating lead');
            }
        });

        // Delete lead
        async function deleteLead(id) {
            if (!confirm('Are you sure you want to delete this lead?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}?action=lead&id=${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    fetchLeads();
                    alert('Lead deleted successfully!');
                }
            } catch (error) {
                console.error('Error deleting lead:', error);
                alert('Error deleting lead');
            }
        }

        // Filter leads
        function filterLeads() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const stage = document.getElementById('stageFilter').value;
            const source = document.getElementById('sourceFilter').value;
            const assigned = document.getElementById('assignedFilter').value;

            const filtered = allLeads.filter(lead => {
                const matchSearch = !search || 
                    lead.name.toLowerCase().includes(search) || 
                    lead.company.toLowerCase().includes(search);
                const matchStage = !stage || lead.stage === stage;
                const matchSource = !source || lead.source === source;
                const matchAssigned = !assigned || lead.assigned_to === assigned;
                return matchSearch && matchStage && matchSource && matchAssigned;
            });

            renderLeads(filtered);
        }

        // Export leads
        function exportLeads() {
            const csv = [
                ['Name', 'Company', 'Email', 'Phone', 'Source', 'Stage', 'Status', 'Value', 'Assigned To'],
                ...allLeads.map(l => [l.name, l.company, l.email, l.phone, l.source, l.stage, l.status, l.value, l.assigned_to])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sales_leads.csv';
            a.click();
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', filterLeads);
        document.getElementById('stageFilter').addEventListener('change', filterLeads);
        document.getElementById('sourceFilter').addEventListener('change', filterLeads);
        document.getElementById('assignedFilter').addEventListener('change', filterLeads);

        // Initial load
        fetchLeads();
    </script>
</body>
</html>