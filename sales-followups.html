<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Follow-up Tasks Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="static-sales-dashboard.html">
                <i class="bi bi-grid-3x3-gap-fill me-2"></i>CRM Dashboard
            </a>
            <div class="d-flex align-items-center">
                <a href="static-sales-dashboard.html" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1">Follow-up Tasks</h2>
                <p class="text-muted mb-0">Manage your scheduled follow-ups and tasks</p>
            </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFollowupModal">
                <i class="bi bi-plus-lg me-2"></i>Add Follow-up
            </button>
        </div>

        <!-- Stats Cards -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="bg-warning bg-opacity-10 p-3 rounded me-3">
                                <i class="bi bi-clock text-warning fs-4"></i>
                            </div>
                            <div>
                                <h4 class="mb-0" id="pendingCount">0</h4>
                                <small class="text-muted">Pending</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="bg-success bg-opacity-10 p-3 rounded me-3">
                                <i class="bi bi-check-circle text-success fs-4"></i>
                            </div>
                            <div>
                                <h4 class="mb-0" id="doneCount">0</h4>
                                <small class="text-muted">Completed</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="bg-danger bg-opacity-10 p-3 rounded me-3">
                                <i class="bi bi-exclamation-circle text-danger fs-4"></i>
                            </div>
                            <div>
                                <h4 class="mb-0" id="overdueCount">0</h4>
                                <small class="text-muted">Overdue</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 p-3 rounded me-3">
                                <i class="bi bi-calendar-event text-primary fs-4"></i>
                            </div>
                            <div>
                                <h4 class="mb-0" id="todayCount">0</h4>
                                <small class="text-muted">Today</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Followups Table -->
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0">All Follow-ups</h6>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" id="statusFilter" style="width: 150px;">
                        <option value="">All Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Done">Done</option>
                        <option value="Contacted">Contacted</option>
                    </select>
                    <select class="form-select form-select-sm" id="typeFilter" style="width: 150px;">
                        <option value="">All Types</option>
                        <option value="Call">Call</option>
                        <option value="Meeting">Meeting</option>
                        <option value="Email">Email</option>
                    </select>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Contact</th>
                                <th>Company</th>
                                <th>Task</th>
                                <th>Type</th>
                                <th>Scheduled</th>
                                <th>Status</th>
                                <th>Assigned To</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="followupsTableBody">
                            <tr>
                                <td colspan="8" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Followup Modal -->
    <div class="modal fade" id="addFollowupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Follow-up Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addFollowupForm">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Contact Name *</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Company *</label>
                                <input type="text" class="form-control" name="company" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Task *</label>
                                <input type="text" class="form-control" name="task" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Type</label>
                                <select class="form-select" name="task_type">
                                    <option value="Call">Call</option>
                                    <option value="Meeting">Meeting</option>
                                    <option value="Email">Email</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Assigned To</label>
                                <select class="form-select" name="assigned_to">
                                    <option value="TRM">TRM</option>
                                    <option value="ZRM">ZRM</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Scheduled Time *</label>
                                <input type="datetime-local" class="form-control" name="scheduled_time" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" name="notes" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Task</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = 'https://jyxpsdqgrnkgknpskgdv.supabase.co/functions/v1/sales-api';
        let allFollowups = [];

        async function fetchFollowups() {
            try {
                const response = await fetch(`${API_BASE_URL}?action=followups`);
                const data = await response.json();
                allFollowups = data.followups || [];
                renderFollowups(allFollowups);
                updateStats(allFollowups);
            } catch (error) {
                console.error('Error fetching followups:', error);
            }
        }

        function updateStats(followups) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            document.getElementById('pendingCount').textContent = followups.filter(f => f.status === 'Pending').length;
            document.getElementById('doneCount').textContent = followups.filter(f => f.status === 'Done').length;
            document.getElementById('overdueCount').textContent = followups.filter(f => 
                f.status === 'Pending' && new Date(f.scheduled_time) < now
            ).length;
            document.getElementById('todayCount').textContent = followups.filter(f => {
                const scheduled = new Date(f.scheduled_time);
                return scheduled >= today && scheduled < tomorrow;
            }).length;
        }

        function renderFollowups(followups) {
            const tbody = document.getElementById('followupsTableBody');
            
            if (!followups || followups.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center py-5">No follow-ups found</td></tr>`;
                return;
            }

            const now = new Date();

            tbody.innerHTML = followups.map(f => {
                const scheduled = new Date(f.scheduled_time);
                const isOverdue = f.status === 'Pending' && scheduled < now;
                
                return `
                    <tr class="${isOverdue ? 'table-danger' : ''}">
                        <td class="fw-medium">${f.name}</td>
                        <td>${f.company}</td>
                        <td>${f.task}</td>
                        <td>
                            <span class="badge ${getTypeClass(f.task_type)}">
                                <i class="bi ${getTypeIcon(f.task_type)} me-1"></i>${f.task_type}
                            </span>
                        </td>
                        <td>${scheduled.toLocaleString()}</td>
                        <td>
                            <span class="badge ${getStatusClass(f.status)}">${f.status}</span>
                            ${isOverdue ? '<span class="badge bg-danger ms-1">Overdue</span>' : ''}
                        </td>
                        <td>${f.assigned_to || '-'}</td>
                        <td>
                            ${f.status !== 'Done' ? `
                                <button class="btn btn-sm btn-success me-1" onclick="markDone('${f.id}')" title="Mark as Done">
                                    <i class="bi bi-check"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteFollowup('${f.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getTypeClass(type) {
            const classes = { 'Call': 'bg-primary', 'Meeting': 'bg-success', 'Email': 'bg-info' };
            return classes[type] || 'bg-secondary';
        }

        function getTypeIcon(type) {
            const icons = { 'Call': 'bi-telephone', 'Meeting': 'bi-calendar-event', 'Email': 'bi-envelope' };
            return icons[type] || 'bi-list';
        }

        function getStatusClass(status) {
            const classes = { 'Done': 'bg-success', 'Pending': 'bg-warning text-dark', 'Contacted': 'bg-info' };
            return classes[status] || 'bg-secondary';
        }

        // Add followup
        document.getElementById('addFollowupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.status = 'Pending';

            try {
                const response = await fetch(`${API_BASE_URL}?action=followup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('addFollowupModal')).hide();
                    e.target.reset();
                    fetchFollowups();
                    alert('Follow-up added successfully!');
                }
            } catch (error) {
                console.error('Error adding followup:', error);
            }
        });

        // Mark as done
        async function markDone(id) {
            try {
                const response = await fetch(`${API_BASE_URL}?action=followup&id=${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'Done' })
                });
                
                if (response.ok) {
                    fetchFollowups();
                }
            } catch (error) {
                console.error('Error updating followup:', error);
            }
        }

        // Delete followup
        async function deleteFollowup(id) {
            if (!confirm('Are you sure you want to delete this follow-up?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}?action=followup&id=${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    fetchFollowups();
                    alert('Follow-up deleted!');
                }
            } catch (error) {
                console.error('Error deleting followup:', error);
            }
        }

        // Filters
        document.getElementById('statusFilter').addEventListener('change', filterFollowups);
        document.getElementById('typeFilter').addEventListener('change', filterFollowups);

        function filterFollowups() {
            const status = document.getElementById('statusFilter').value;
            const type = document.getElementById('typeFilter').value;

            const filtered = allFollowups.filter(f => {
                const matchStatus = !status || f.status === status;
                const matchType = !type || f.task_type === type;
                return matchStatus && matchType;
            });

            renderFollowups(filtered);
        }

        fetchFollowups();
    </script>
</body>
</html>